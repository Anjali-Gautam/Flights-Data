---
title: "Commercial Flight Landing"
author: 'Submitted by: Anjali Gautam'
output: rmarkdown::github_document
---
```{r message=FALSE, warning=FALSE, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  fig.path = "README_figs/README-"
)

knitr::opts_knit$set(root.dir = "D:\\Cincinnati\\Classes\\12. Statistical Modelling")
```

#### Importing Libraries 

```{r warning=FALSE}
library(broom)
library(readxl)
library(tidyverse)
library(DataExplorer)
library(MASS)
library(lattice)
library(ggplot2)
```

#### Reading the two Files

```{r message=FALSE, warning=FALSE}
setwd("D:\\Cincinnati\\Classes\\12. Statistical Modelling")
faa1 <- read_excel("FAA1.xls")
faa2 <- read_excel("FAA2.xls")
```

##### Checking the Structure of the files
```{r}
str(faa1)
```

```{r}
str(faa2)
```

* There are 800 observations and 8 variables in Faa1 dataset
* There are 150 observations and 7 variables in Faa2 dataset
* Duration variable is only present in Faa1 dataset and rest of the variables are same in both


#### Merging the two datasets

We will also check for duplicates on common variables between the two datasets

```{r}
flights <- dplyr :: bind_rows(faa1,faa2)

head(flights)
```

```{r}
sum(duplicated(subset(flights,select=-c(duration))))
```

There are 100 duplications in the dataset. Since Duration is missing for the faa2 data observations because of variable not present in that table. We will drop duplicates. 

```{r}
flights <- flights %>% distinct(aircraft,distance,no_pasg,speed_ground,speed_air,height,pitch,.keep_all=TRUE)
```

#### Merged Data

Checking its size and summary of each variable 

###### Size of Combined data

```{r}
dim(flights)
```

Combined data has 850 observations and 8 variables 

###### Structure of the combined data

```{r}
str(flights)
```

###### Summary of all columns in the combined data

```{r}
summary(flights)
```

##### Observations so far from the Dataset 

* Duration variable is not present in both the tables 
* There are 100 duplicates in the combined dataset
* Speed air has more than 70% NA values in the dataset 
* Duration field has 50 missing values
* There are 850 rows and 8 rows in the dataset after deleting duplicates
* Out of 8 columns aircraft is a categorical variable and other 7 are quantitative variable 

#### Detecting and removing abnormal observations

```{r}

abnormal_duration <- flights[(flights$duration < 40 & (is.na(flights$duration)==F)),]
abnormal_speed_air <- flights[((flights$speed_air< 30 | flights$speed_air > 140) & (is.na(flights$speed_air)==F)),]

abnormal_speed_ground <- flights[(flights$speed_ground< 30 | flights$speed_ground > 140),]

abnormal_height <- flights[flights$height < 6,]

abnormal_distance <- flights[flights$distance>6000,]
  
v <- filter(flights,(flights$duration > 40 | is.na(flights$duration)==T))
dim(v)
v <- filter(v,((v$speed_air >=30 & v$speed_air <= 140)|is.na(v$speed_air)==T))
dim(v)
v <- filter(v,(v$speed_ground >=30 & v$speed_ground <= 140))
dim(v)
v <- filter(v,v$height >= 6)
dim(v)

```

* There are 5 abnormal values for duration
* There is 1 abnormal value for speed_air
* There are 3 abnormal values for speed_ground
* There are 10 abnormal values for height
* There is 1 abnormal observation common to speed_air and speed_ground
* Total 18 abnormal observations are removed from the dataset 

#### Structure and summary of the new dataset 

```{r}
flights_new <- v
str(flights_new)
dim(flights_new)
summary(flights_new)
```

Dataset have now 832 observations and 8 variables

#### Plots

###### Histogram for all the numeric variables 

```{r}
plot_histogram(flights_new)
```

###### Barplot 

```{r}
plot_bar(flights_new$aircraft)
```

* Cleaned Data has now 832 observations and 8 variables
* Duration still have 50 NA values and speed_air has 628 NA values 
* From histograms, distance has a right skewed distribution 
* From histograms, apart from distance and speed_air variables have normal distribution
* From bar plot, we observe that airbus have more observations than boeing 

#### Correlation Analysis 

Pairwise correlation between Landing distance(distance field) and all other fields

```{r}
corr_func <- function(dat) {
corr_col <- list(cor(y=dat$distance,x=dat[2:7],use="complete.obs"))
corr_df = as.data.frame(corr_col)
colnames(corr_df) = "Correlation"
corr_df['Trend'] = ifelse(corr_df$Correlation > 0 , "Positive", "Negative")
corr_df <- corr_df[order(-abs(corr_df$Correlation)),]
Table <- corr_df
return(Table)
}
Table1 <- corr_func(flights_new)
Table1
```

#### Scatterplot Matrix 

```{r}
scatter_func <- function(dat,name){
attach(dat)
return(pairs(~distance+duration+no_pasg+speed_ground+speed_air+pitch+height,main= name,
      pch=21, bg = 'blue'))
detach(dat)
}

scatter_func(flights_new,"Scatterplot for Flights Data")
```

#### Binary Coding

Coding aircraft in binary variable airbus = 1 and boeing =0

```{r}
flights_new['aircraft'] <- ifelse(flights_new$aircraft=="airbus",1,0)
as.data.frame(table(flights_new$aircraft))

airbus <- flights_new[flights_new$aircraft==1,]
boeing <- flights_new[flights_new$aircraft==0,]
```

There are 388 boeing and 444 airbus observations in the data respectively

#### Correlation Analysis for both the datasets 

```{r}
corr_func(airbus)
```

```{r}
corr_func(boeing)
```

```{r}
scatter_func(airbus,"Scatterplot for Airbus")
```

```{r}
scatter_func(boeing,"Scatterplot for Boeing")
```


#### Regressing Landing distance on each of the variables in the dataset

```{r}

p1 <- tidy(lm(distance~duration,data=flights_new))$p.value[2]
p2 <- tidy(lm(distance~no_pasg,data=flights_new))$p.value[2]
p3 <- tidy(lm(distance~speed_air,data=flights_new))$p.value[2]
p4 <- tidy(lm(distance~speed_ground,data=flights_new))$p.value[2]
p5 <- tidy(lm(distance~pitch,data=flights_new))$p.value[2]
p6 <- tidy(lm(distance~height,data=flights_new))$p.value[2]
p7 <- tidy(lm(distance~aircraft,data=flights_new))$p.value[2]

reg1 <- tidy(lm(distance~duration,data=flights_new))$estimate[2]
reg2 <- tidy(lm(distance~no_pasg,data=flights_new))$estimate[2]
reg3 <- tidy(lm(distance~speed_air,data=flights_new))$estimate[2]
reg4 <- tidy(lm(distance~speed_ground,data=flights_new))$estimate[2]
reg5 <- tidy(lm(distance~pitch,data=flights_new))$estimate[2]
reg6 <- tidy(lm(distance~height,data=flights_new))$estimate[2]
reg7 <- tidy(lm(distance~aircraft,data=flights_new))$estimate[2]

p.values <- c(p1,p2,p3,p4,p5,p6,p7)
vars <- c("duration","no_pasg","speed_air","speed_ground","pitch","height","aircraft")
reg.values <- c(reg1,reg2,reg3,reg4,reg5,reg6,reg7)

Table2 <- as.data.frame(cbind(p.values,reg.values))

rownames(Table2) <- vars

Table2['reg.values'] <- ifelse(Table2$reg.values<0,"Negative","Positive")
Table2 <- Table2[order(Table2$p.values),]
Table2['vars'] <- rownames(Table2)

```

###### Table2 ordered from most significance to least significant variable on the basis of p.value

```{r}
Table2

```

#### Standardise each predictor variable 

```{r}

flights_scaled <- as.data.frame(scale(flights_new))
flights_scaled['distance'] <- flights_new['distance']
summary(flights_scaled)

scaled_model <- lm(distance~.,data=flights_scaled)
summary(scaled_model)
```

###### Table3

```{r}
p1s <- tidy(lm(distance~duration,data=flights_scaled))$p.value[2]
p2s <- tidy(lm(distance~no_pasg,data=flights_scaled))$p.value[2]
p3s <- tidy(lm(distance~speed_air,data=flights_scaled))$p.value[2]
p4s <- tidy(lm(distance~speed_ground,data=flights_scaled))$p.value[2]
p5s <- tidy(lm(distance~pitch,data=flights_scaled))$p.value[2]
p6s <- tidy(lm(distance~height,data=flights_scaled))$p.value[2]
p7s <- tidy(lm(distance~aircraft,data=flights_scaled))$p.value[2]

reg1s <- tidy(lm(distance~duration,data=flights_scaled))$estimate[2]
reg2s <- tidy(lm(distance~no_pasg,data=flights_scaled))$estimate[2]
reg3s <- tidy(lm(distance~speed_air,data=flights_scaled))$estimate[2]
reg4s <- tidy(lm(distance~speed_ground,data=flights_scaled))$estimate[2]
reg5s <- tidy(lm(distance~pitch,data=flights_scaled))$estimate[2]
reg6s <- tidy(lm(distance~height,data=flights_scaled))$estimate[2]
reg7s <- tidy(lm(distance~aircraft,data=flights_scaled))$estimate[2]

p.values.s <- list(p1s,p2s,p3s,p4s,p5s,p6s,p7s)
vars.s <- list("duration","no_pasg","speed_air","speed_ground","pitch","height","aircraft")
reg.values.s <- c(reg1s,reg2s,reg3s,reg4s,reg5s,reg6s,reg7s)

Table3 <- as.data.frame(reg.values.s)

rownames(Table3) <- vars

Table3['Direction'] <- ifelse(Table3$reg.values.s<0,"Negative","Positive")
Table3 <- Table3[order(-abs(Table3$reg.values.s)),]
Table3
```

```{r}
Table1
```

```{r}
Table2
```

```{r}
Table3
```

The results are not consistent between table 1,2, and 3
Starting from Table 1, we see that speed air and speed ground are highly correlated to the Landing distance and duration and number off passenger have least.

From Table 2, we observe similar trend but here speed_ground has is more significant than speed_air

From Table 3, we still find speed air and speed_ground of being high significance followed by aircraft and height 

#### Creating Master Table (Table0) based on Tables 1,2, and 3

```{r}
Table0 <- c("speed_air","speed_ground","height","aircraft", "pitch","no_pasg","duration")

Table0

```

#### Regression Coefficients for different models

```{r}
Model1 <- lm(distance~speed_ground,data=flights_new)

Model2 <- lm(distance~speed_air,data=flights_new)

Model3 <- lm(distance~speed_ground+speed_air,data=flights_new)

summary(Model1)
summary(Model2)
summary(Model3)

```

We do observe a change of signs for the coefficient of speed_ground. We will check correlation     between speed air and speed ground


###### Correlation between speed_air and speed_ground

```{r}
(corr.SA.SG <- cor(flights_new$speed_air,flights_new$speed_ground,use="complete.obs"))
```

The two variables are higly correlated. I will keep speed air based on Table0 Ranking list.

#### Fitting six models as per ranking in Table0

```{r}
test <- flights_new[c(8,5,6,1,7,3,2)]
arr = array(data=NA,dim=6)
adjarr = array(data=NA,dim=6)
aicarr = array(data=NA,dim=6)
size = array(data=NA,dim=6)
for (i in 2:7){
  datf <- test[,1:i]
  reg_model <- lm(distance~.,data=datf)
  rsq <- summary(reg_model)$r.squared
  adrsq <- summary(reg_model)$adj.r.squared
  aic <- AIC(reg_model)
  arr[i-1]=rsq
  adjarr[i-1]=adrsq
  aicarr[i-1] = aic
  size[i-1]=i-1
}
```

#### Plotting R.Squared values against number of variables

```{r}
plot(size,arr,t="l")
```
 
We observe an increasing pattern. R-square value is increasing with increase in number of          variables in the model

#### Using adjusted R-square values 

```{r}
plot(size,adjarr,t="l")
```

#### Using AIC values

```{r}
plot(size,aicarr,type="l")
```

I will select below variables for building the predictive model for Landing distance from the observations so far
    
    * speed_air
    * height
    * pitch
    * aircraft

#### Forward variable selection using StepAIC

```{r}

non_nadata <- filter(flights_new,is.na(flights_new$speed_air)==F & is.na(flights_new$duration)==F)
first_model = lm(distance~1,data=non_nadata)
non_naregmodel <- lm(distance~speed_air+height+aircraft+pitch+no_pasg+duration,data=non_nadata)

stepAIC(first_model,direction="forward",scope=list(lower=first_model,upper=non_naregmodel))


```

* From step 19, the AIC decreases till 3rd point where the variables considered are speed_air, height and aircraft after which when pitch is added it increases.
* From step 21, using stepAIC gave similar results. Starting from step 1 where AIC is 2652.17, the model adds in speed_air which gives lower AIC. Since we have chosen forward    selection method the model stops where adding any new variable will only decrease the AIC
* From the above analysis, the optimal model we get is Landing distance regressed over speed_air, aircraft, and height

